<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcade Host Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        /* Custom styles for the game iframe to take up max space */
        .game-iframe {
            width: 100%;
            height: calc(100vh - 12rem);
            border: 4px solid #4f46e5;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            background-color: white;
        }
    </style>
</head>
<body>
    <div id="root">
        <div id="app-loading" style="height:100vh;display:flex;align-items:center;justify-content:center;background:#f3f4f6;font-family:Inter, system-ui, -apple-system;">
            <div style="text-align:center;color:#374151">
                <div style="font-size:24px;font-weight:600;margin-bottom:8px">Loading app…</div>
                <div style="color:#6b7280">If this message persists, open DevTools → Console to see errors.</div>
            </div>
        </div>
    </div>

    <script>
        window.__firebase_config = {
            apiKey: "AIzaSyCrVhsbABjUW5pRGt4Tf0-T9KlHGjux-z4",
            authDomain: "wiiizzz786games.firebaseapp.com",
            projectId: "wiiizzz786games",
            storageBucket: "wiiizzz786games.firebasestorage.app",
            messagingSenderId: "719578059323",
            appId: "1:719578059323:web:cc822225b1fadf303d021e",
            measurementId: "G-8FVD56NSCT"
        };
        // short id used by this app for Firestore paths
        window.__app_id = 'wiiizzz786games';
    </script>

    <script src="https://unpkg.com/lucide-react@latest/umd/lucide-react.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // ONLY anonymous sign-in is needed for auth
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, addDoc, serverTimestamp, doc, setDoc, where, getDocs, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase functions globally for the Babel script
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signOut, 
            getFirestore, collection, onSnapshot, query, addDoc, serverTimestamp, doc, setDoc, where, getDocs, getDoc, updateDoc, 
        };
    </script>

    <script>
        (function(){
            try {
                const cfg = window.__firebase_config || null;
                if (!cfg) { console.log('No window.__firebase_config found; skipping early firebase initialize.'); return; }
                if (!window.firebase || !window.firebase.initializeApp) { console.warn('Firebase SDK not available yet; ensure the module script loaded.'); return; }
                
                try {
                    const app = window.firebase.initializeApp(cfg);
                    window.__firebase_app = app;
                    window.__firebase_auth = window.firebase.getAuth ? window.firebase.getAuth(app) : null;
                    window.__firebase_db = window.firebase.getFirestore ? window.firebase.getFirestore(app) : null;
                    window.__fb_ready = true;
                    console.log('Firebase initialized (early):', !!window.__firebase_app);
                } catch (e) {
                    console.warn('Early firebase initializeApp failed:', e && e.message ? e.message : e);
                }
            } catch (err) { console.error('Early firebase init wrapper error', err); }
        })();
    </script>
    
    <script type="text/babel">
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const { useState, useEffect } = React;
        
        // --- Setup and Utilities ---
        
        // Error handling omitted for brevity but should be kept in production

        const getIcon = (name) => {
            if (window.lucide && window.lucide[name]) return window.lucide[name];
            return ({ className = '', ...props }) => React.createElement('span', { className: `inline-block ${className}`, ...props }, '[icon]');
        };

        const RefreshCw = getIcon('RefreshCw');
        const Code = getIcon('Code');
        const UserPlus = getIcon('UserPlus');
        const Settings = getIcon('Settings');
        const UploadCloud = getIcon('UploadCloud');
        const Key = getIcon('Key');

        const encodeBase64 = (s) => { try { return btoa(unescape(encodeURIComponent(s))); } catch(e){ return ''; } };
        const decodeBase64 = (s) => { try { return decodeURIComponent(escape(atob(s))); } catch(e){ return 'Invalid base64'; } };

        // Firebase wrappers
        const fb = window.firebase || null;
        let useFirebase = false;
        let fbAuth = null, fbDb = null;

        if (fb) {
            fbAuth = window.__firebase_auth;
            fbDb = window.__firebase_db;
            useFirebase = !!(fbAuth && fbDb);
            console.log('Firebase ready status in React:', useFirebase);
        }

        // --- Custom User/Profile Management Functions ---
        
        // **RESTORED:** Finds user profile by username in Firestore
        const findUserByUsername = async (username) => {
            if (!useFirebase) return { found: false };
            try {
                const usersRef = fb.collection(fbDb, `/artifacts/${appId}/public/data/users`);
                const q = fb.query(usersRef, fb.where('username', '==', username));
                const snap = await fb.getDocs(q);
                if (!snap.empty) return { found: true, doc: snap.docs[0] };
            } catch (e) { console.warn('findUser error', e.message); }
            return { found: false };
        };

        // **RESTORED:** Creates or updates the user profile in Firestore
        const createOrUpdateUser = async (uid, payload) => {
            if (!useFirebase) return true;
            try {
                const ref = fb.doc(fbDb, `/artifacts/${appId}/public/data/users`, uid);
                await fb.setDoc(ref, payload, { merge: true });
                return true;
            } catch (e) { console.error('set user profile error', e); return false; }
        };
        
        // --- Data Persistence (Game, Request, Progress) Functions ---
        
        const addGameDoc = async (payload) => { /* Logic as before */
            if (!useFirebase) { try { const key = `mock_games_${appId}`; const list = JSON.parse(localStorage.getItem(key) || '[]'); list.push(Object.assign({}, payload, { _localSavedAt: Date.now() })); localStorage.setItem(key, JSON.stringify(list)); console.warn('addGameDoc: saved to localStorage mock:', payload); return { ok: true, mock: true }; } catch (e) { return { ok: false, error: 'No firebase and localStorage failed: ' + (e && e.message) }; } }
            try { const gamesRef = fb.collection(fbDb, `/artifacts/${appId}/public/data/games`); await fb.addDoc(gamesRef, payload); return { ok: true }; } catch (e) { return { ok: false, error: e.message }; }
        };

        const addRequestDoc = async (payload) => { /* Logic as before */
            if (!useFirebase) { try { const key = `mock_requests_${appId}`; const list = JSON.parse(localStorage.getItem(key) || '[]'); list.push(Object.assign({}, payload, { _localSavedAt: Date.now() })); localStorage.setItem(key, JSON.stringify(list)); console.warn('addRequestDoc: saved to localStorage mock:', payload); return { ok: true, mock: true }; } catch (e) { return { ok: false, error: e.message }; } }
            try { const reqRef = fb.collection(fbDb, `/artifacts/${appId}/public/data/requests`); await fb.addDoc(reqRef, Object.assign({}, payload, { createdAt: fb && fb.serverTimestamp ? fb.serverTimestamp() : Date.now(), status: 'open' })); return { ok: true }; } catch (e) { return { ok: false, error: e.message }; }
        };

        const saveProgress = async (gameId, uid, progress) => { /* Logic as before */
            if (!gameId || !uid) return { ok: false, error: 'missing gameId or uid' }; const payload = { gameId, userId: uid, progress, updatedAt: fb && fb.serverTimestamp ? fb.serverTimestamp() : Date.now() };
            if (!useFirebase) { try { const key = `progress_${appId}_${uid}_${gameId}`; localStorage.setItem(key, JSON.stringify(payload)); return { ok: true, mock: true }; } catch (e) { return { ok: false, error: e.message }; } }
            try { const ref = fb.doc(fbDb, `/artifacts/${appId}/public/data/progress`, `${uid}_${gameId}`); await fb.setDoc(ref, payload, { merge: true }); return { ok: true }; } catch (e) { return { ok: false, error: e.message }; }
        };

        const loadProgress = async (gameId, uid) => { /* Logic as before */
            if (!gameId || !uid) return null;
            if (!useFirebase) { const key = `progress_${appId}_${uid}_${gameId}`; try { return JSON.parse(localStorage.getItem(key)); } catch(e){ return null; } }
            try { const ref = fb.doc(fbDb, `/artifacts/${appId}/public/data/progress`, `${uid}_${gameId}`); const snap = await fb.getDoc(ref); if (snap && snap.exists) return snap.data(); return null; } catch(e){ console.error('loadProgress', e); return null; }
        };

        // --- AUTH SCREEN (RESTORED: ANONYMOUS) ---
        const AuthScreen = ({ onAuth }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [username, setUsername] = useState(''); 
            const [status, setStatus] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setStatus('');
                if (username.length < 3) { setStatus('Username must be 3+ chars'); return; }

                // --- LOCAL/MOCK MODE FALLBACK ---
                if (!useFirebase) {
                    setStatus("Warning: Firebase not active. Logging in with mock data.");
                    onAuth({ uid: 'local-'+Date.now(), username, role: 'player' });
                    return;
                }
                
                try {
                    // 1. Check if the username is taken in the profile database
                    const { found, doc } = await findUserByUsername(username);

                    if (isLogin) {
                        // --- ANONYMOUS LOGIN (Simulated) ---
                        if (!found) { 
                            setStatus('Account not found. Please register.'); 
                            return; 
                        }
                        
                        const profileData = doc.data();
                        
                        // Sign in anonymously to get a UID for session tracking
                        const authResult = await fb.signInAnonymously(fbAuth);
                        const user = authResult.user;

                        // Update the profile to link the new anonymous UID (if necessary)
                        await createOrUpdateUser(user.uid, { ...profileData, lastActivity: fb.serverTimestamp() });

                        onAuth({ uid: user.uid, ...profileData });

                    } else {
                        // --- ANONYMOUS REGISTRATION ---
                        if (found) { 
                            setStatus('Username already taken.'); 
                            return; 
                        }

                        // Sign in anonymously to get a unique UID
                        const authResult = await fb.signInAnonymously(fbAuth);
                        const user = authResult.user;

                        // Create the profile in Firestore using the new anonymous UID
                        const newProfile = { 
                            username, 
                            role: 'player', 
                            lastActivity: fb.serverTimestamp(), 
                            userId: user.uid 
                        };
                        await createOrUpdateUser(user.uid, newProfile);
                        
                        onAuth({ uid: user.uid, ...newProfile });
                    }
                } catch (err) {
                    console.error('Auth error', err);
                    setStatus(`Authentication failed: ${err.message || 'unknown error'}`);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-6">
                    <div className="w-full max-w-md bg-white p-8 rounded-xl shadow-lg">
                        <h2 className="text-2xl font-bold mb-4">{isLogin ? 'Sign In' : 'Register'}</h2>
                        {status && <div className="mb-3 p-2 bg-yellow-50 text-yellow-900 rounded">{status}</div>}
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input className="w-full p-3 border rounded" placeholder="Username" value={username} onChange={e=>setUsername(e.target.value)} />
                            <button className="w-full bg-indigo-600 text-white p-3 rounded">{isLogin ? 'Log In' : 'Register'}</button>
                        </form>
                        <div className="mt-4 text-sm text-center">
                            <button className="text-indigo-600" onClick={()=>{setIsLogin(!isLogin); setStatus('');}}>
                                {isLogin ? 'Need an account? Register' : 'Have an account? Sign in'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- All other components follow (RequestGame, AdminRequests, etc.) ---
        
        const RequestGame = ({ onBack, user }) => { /* ... (Same as before) ... */
            const [title, setTitle] = useState(''); const [details, setDetails] = useState(''); const [status, setStatus] = useState('');
            const handleSubmit = async (e) => { e.preventDefault(); setStatus(''); if (!title) { setStatus('Provide a title'); return; } const payload = { title, details, requestedBy: user ? user.username || user.uid : 'anon', requesterId: user?user.uid:null }; const res = await addRequestDoc(payload); if (res.ok) { setStatus('Request submitted'); setTitle(''); setDetails(''); } else setStatus('Failed: '+(res.error||'unknown')); };
            return (
                <div className="p-6 max-w-2xl mx-auto"><div className="mb-4 flex items-center justify-between"><h2 className="text-xl font-bold">Request a Game</h2><button onClick={onBack} className="text-indigo-600">Back</button></div>
                    <form onSubmit={handleSubmit} className="space-y-3 bg-white p-4 rounded shadow">{status && <div className="p-2 bg-yellow-50">{status}</div>}<input className="w-full p-3 border" placeholder="Game title" value={title} onChange={e=>setTitle(e.target.value)} /><textarea rows={6} className="w-full p-3 border" placeholder="Details / why you want it" value={details} onChange={e=>setDetails(e.target.value)} /><button className="px-4 py-2 bg-indigo-600 text-white rounded" type="submit">Send Request</button></form></div>
            );
        };

        const AdminRequests = ({ onBack }) => { /* ... (Same as before) ... */
            const [requests, setRequests] = useState([]);
            useEffect(()=>{ let mounted=true; (async ()=>{
                if (useFirebase && fb.getDocs) { const col = fb.collection(fbDb, `/artifacts/${appId}/public/data/requests`); const snap = await fb.getDocs(col); const list=[]; snap.forEach(d=>list.push({id:d.id, ...d.data()})); if(mounted) setRequests(list); } 
                else { const key = `mock_requests_${appId}`; const list = JSON.parse(localStorage.getItem(key)||'[]'); if(mounted) setRequests(list.map((r,i)=>({id:'local-'+i, ...r}))); }
            })(); return ()=>{mounted=false}; },[]);
            const markResolved = async (id)=>{
                if (!useFirebase) { const key = `mock_requests_${appId}`; const list = JSON.parse(localStorage.getItem(key)||'[]'); const updated = list.map((r,i)=> i===parseInt(id.replace('local-','')) ? Object.assign({}, r, { status:'resolved' }) : r); localStorage.setItem(key, JSON.stringify(updated)); setRequests(updated); return; }
                try { const ref = fb.doc(fbDb, `/artifacts/${appId}/public/data/requests`, id); await fb.updateDoc(ref, { status: 'resolved' }); setRequests(requests.map(r=> r.id===id ? Object.assign({}, r, { status:'resolved' }) : r)); } catch(e){ console.error(e); }
            };
            return (
                <div className="p-6 max-w-4xl mx-auto"><div className="mb-4 flex items-center justify-between"><h2 className="text-xl font-bold">Game Requests</h2><button onClick={onBack} className="text-indigo-600">Back</button></div>
                    {requests.length===0 && <div className="p-4 bg-yellow-50">No requests</div>}
                    {requests.map(r=> (<div key={r.id} className="p-3 bg-white rounded shadow flex justify-between items-center mb-2">
                        <div><div className="font-semibold">{r.title}</div><div className="text-sm text-gray-600">by {r.requestedBy || r.requesterId || 'unknown'}</div><div className="text-sm text-gray-700">{r.details}</div></div>
                        <div><div className="mb-2">{r.status || 'open'}</div><button className="px-3 py-1 bg-green-600 text-white rounded mr-2">Add Game</button><button className="px-3 py-1 bg-gray-200 rounded" onClick={()=>markResolved(r.id)}>Resolve</button></div>
                    </div>))}
                </div>
            );
        };
        
        const EncoderDecoder = ({ onBack }) => { /* ... (Same as before) ... */
            const [input, setInput] = useState(''); const [output, setOutput] = useState(''); const [mode, setMode] = useState('encode');
            const handleRun = ()=> setOutput(mode==='encode'?encodeBase64(input):decodeBase64(input));
            return (
                <div className="p-6"><div className="mb-4 flex items-center justify-between"><h3 className="text-xl font-bold">Content Encoder & Decoder</h3><button className="text-sm text-indigo-600" onClick={onBack}>Back</button></div>
                    <div className="space-y-3"><textarea rows={8} className="w-full p-3 border" value={input} onChange={e=>setInput(e.target.value)} placeholder={mode==='encode' ? 'Paste HTML here...' : 'Paste base64 here...'} /><div className="flex gap-2">
                        <button className="px-4 py-2 bg-purple-600 text-white rounded" onClick={()=>{ setMode('encode'); setOutput('');}}>Encode</button><button className="px-4 py-2 bg-gray-200 rounded" onClick={()=>{ setMode('decode'); setOutput('');}}>Decode</button>
                        <button className="px-4 py-2 bg-indigo-600 text-white rounded" onClick={handleRun}>Run</button></div>
                        <textarea rows={6} className="w-full p-3 border bg-gray-50" value={output} readOnly /></div></div>
            );
        };

        const AdminPanel = ({ user, db, onBack }) => { /* ... (Same as before) ... */
            const [title, setTitle] = useState(''); const [encodedGameString, setEncodedGameString] = useState(''); const [message, setMessage] = useState('');
            const handleAddGame = async (e) => { e.preventDefault(); setMessage(''); if (!title || !encodedGameString) { setMessage('Provide title and Base64 string'); return; } if (encodedGameString.length < 10) { setMessage('String too short'); return; }
                const payload = { title, content: encodedGameString, addedBy: user.username || 'unknown', userId: user.uid, createdAt: fb && fb.serverTimestamp ? fb.serverTimestamp() : Date.now() };
                const res = await addGameDoc(payload); if (res.ok) { setMessage('Game added'); setTitle(''); setEncodedGameString(''); } else { setMessage('Failed: ' + (res.error||'unknown')); }
            };
            return (
                <div className="p-6 max-w-3xl mx-auto"><div className="mb-4 flex items-center justify-between"><h2 className="text-xl font-bold">Admin Panel</h2><button onClick={onBack} className="text-indigo-600">Back</button></div>
                    <form onSubmit={handleAddGame} className="space-y-4 bg-white p-4 rounded shadow">
                        {message && <div className="p-2 bg-yellow-50 rounded">{message}</div>}<input className="w-full p-3 border" placeholder="Game title" value={title} onChange={e=>setTitle(e.target.value)} />
                        <textarea rows={6} className="w-full p-3 border" placeholder="Base64 game string" value={encodedGameString} onChange={e=>setEncodedGameString(e.target.value)} />
                        <div className="flex gap-2"><button className="px-4 py-2 bg-red-500 text-white rounded" type="submit">Publish Game</button></div></form></div>
            );
        };

        const ViewGames = ({ onBack, user }) => { /* ... (Same as before) ... */
            const [games, setGames] = useState([]); const [loading, setLoading] = useState(true);
            useEffect(()=>{ let mounted = true; (async ()=>{ setLoading(true); try { if (useFirebase && fb && fb.getDocs) { const db = fbDb; const col = fb.collection(db, `/artifacts/${appId}/public/data/games`); const snap = await fb.getDocs(col); const list = []; snap.forEach(d => list.push({ id: d.id, ...d.data() })); if (mounted) setGames(list); } else { const key = `mock_games_${appId}`; const list = JSON.parse(localStorage.getItem(key) || '[]'); if (mounted) setGames(list.map((g,i)=>({ id: 'local-'+i, ...g }))); } } catch(e){ console.error('load games', e); } setLoading(false); })(); return ()=>{ mounted=false }; },[]);
            const handlePlay = (g) => { try { const decoded = decodeBase64(g.content || ''); if (!decoded || decoded === 'Invalid base64') return alert('Content not playable or not base64 HTML'); const blob = new Blob([decoded], { type: 'text/html' }); const url = URL.createObjectURL(blob); window.open(url, '_blank'); } catch(e){ alert('Play failed: '+e.message); } };
            const startAutoSave = (g) => { if (!user || !user.uid) return; let interval = setInterval(async ()=>{ const mockProgress = { ts: Date.now(), position: Math.floor(Math.random()*100) }; await saveProgress(g.id, user.uid, mockProgress); console.log('autosaved', g.id); }, 10000); window.addEventListener('beforeunload', ()=> clearInterval(interval)); };
            const handleDownload = (g) => { const blob = new Blob([g.content||''], { type: 'text/plain' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = (g.title||'game') + '.b64'; a.click(); URL.revokeObjectURL(url); };
            return (
                <div className="p-6 max-w-4xl mx-auto"><div className="mb-4 flex items-center justify-between"><h2 className="text-xl font-bold">Available Games</h2><button onClick={onBack} className="text-indigo-600">Back</button></div>
                    {loading ? <div>Loading…</div> : (<div className="space-y-3">
                            {games.length === 0 && <div className="p-4 bg-yellow-50">No games found.</div>}
                            {games.map(g=> (<div key={g.id} className="p-3 bg-white rounded shadow flex items-start justify-between">
                                    <div><div className="font-semibold">{g.title || 'Untitled'}</div><div className="text-sm text-gray-600">by {g.addedBy || g.userId || 'unknown'}</div></div>
                                    <div className="flex gap-2"><button className="px-3 py-1 bg-green-600 text-white rounded" onClick={()=>{ handlePlay(g); startAutoSave(g); }}>Play</button>
                                        <button className="px-3 py-1 bg-gray-200 rounded" onClick={()=>handleDownload(g)}>Download</button>
                                        {user && user.uid && (<><button className="px-3 py-1 bg-blue-600" onClick={async ()=>console.log('Progress:', await loadProgress(g.id, user.uid))}>Progress</button></>)}
                                    </div></div>))
                            }</div>)}</div>
            );
        };

        const MainApp = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('home');

            useEffect(() => {
                const loader = document.getElementById('app-loading');
                if (!useFirebase) {
                    setLoading(false);
                    if (loader) loader.style.display = 'none';
                    return;
                }
                
                // **RESTORED:** Use onAuthStateChanged to manage the anonymous session
                const unsubscribe = fb.onAuthStateChanged(fbAuth, async (fbUser) => {
                    if (fbUser) {
                        try {
                            const userRef = fb.doc(fbDb, `/artifacts/${appId}/public/data/users`, fbUser.uid);
                            const userSnap = await fb.getDoc(userRef);
                            if (userSnap.exists()) {
                                setUser({ uid: fbUser.uid, ...userSnap.data() });
                            } else {
                                // If Auth user exists but no profile, force them to AuthScreen to set a username
                                setUser(null); 
                            }
                        } catch (e) { 
                            console.error('Error fetching user profile:', e); 
                            setUser(null); 
                        }
                    } else {
                        setUser(null);
                    }
                    setLoading(false);
                    if (loader) loader.style.display = 'none';
                });
                
                return () => unsubscribe();
            }, []);
            
            const handleAuthSuccess = (u) => { setUser(u); setView('home'); };

            const handleSignOut = async () => {
                // **RESTORED:** Signing out from Anonymous Auth
                if (fb && fb.signOut && fbAuth) {
                    try {
                        await fb.signOut(fbAuth);
                    } catch (e) { console.error('Sign out failed', e); }
                }
                setUser(null);
                setView('home');
            };

            if (loading) { return <div className="min-h-screen flex items-center justify-center"><RefreshCw className="animate-spin text-indigo-600 w-8 h-8"/></div>; }

            // If user is not logged in or has no profile, show AuthScreen
            if (!user || !user.username) {
                return <AuthScreen onAuth={handleAuthSuccess} />;
            }
            
            const isAdmin = user && user.role === 'admin';

            // Conditional View Rendering
            if (view === 'games') return <ViewGames onBack={() => setView('home')} user={user} />;
            if (view === 'admin') return <AdminPanel user={user} db={fbDb} onBack={() => setView('home')} />;
            if (view === 'encoder') return <EncoderDecoder onBack={() => setView('home')} />;
            if (view === 'request') return <RequestGame user={user} onBack={() => setView('home')} />;
            if (view === 'requests' && isAdmin) return <AdminRequests onBack={() => setView('home')} />;


            // Main Home Screen
            return (
                <div className="container mx-auto p-4 max-w-5xl">
                    <header className="flex justify-between items-center bg-white p-4 rounded-xl shadow mb-6">
                        <h1 className="text-2xl font-bold text-indigo-700">Arcade Host Platform</h1>
                        <div className="flex items-center space-x-4">
                            <span className="text-gray-600 font-medium">Hello, **{user.username || 'User'}**!</span>
                            <button onClick={handleSignOut} className="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition duration-150">Sign Out</button>
                        </div>
                    </header>

                    <main className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <FeatureCard icon={Code} title="Play Games" description="Browse and play all available hosted games." onClick={() => setView('games')} />
                        <FeatureCard icon={UserPlus} title="Request a Game" description="Let the host know what game you want to see next." onClick={() => setView('request')} />
                        {isAdmin && (<><FeatureCard icon={Settings} title="Admin Panel" description="Add new games to the platform." onClick={() => setView('admin')} color="bg-purple-600"/>
                                <FeatureCard icon={UploadCloud} title="View Requests" description="Review pending game requests." onClick={() => setView('requests')} color="bg-purple-600"/>
                                <FeatureCard icon={Key} title="Encode/Decode" description="Utility for base64 encoding/decoding game content." onClick={() => setView('encoder')} color="bg-purple-600"/></>
                        )}
                    </main>
                    
                    {!useFirebase && (
                        <div className="mt-8 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg" role="alert">
                            <strong className="font-bold">Database Warning: </strong>
                            <span className="block sm:inline">Firebase connection failed or is not configured. Using **local mock data only**.</span>
                        </div>
                    )}
                </div>
            );
        };

        const FeatureCard = ({ icon: Icon, title, description, onClick, color = 'bg-indigo-600' }) => (
            <div className="bg-white p-6 rounded-xl shadow-md border-t-4 border-indigo-500 hover:shadow-lg transition cursor-pointer" onClick={onClick}>
                <div className={`p-3 rounded-full inline-block mb-4 text-white ${color}`}><Icon className="w-6 h-6" /></div>
                <h3 className="text-xl font-semibold mb-2">{title}</h3>
                <p className="text-gray-600">{description}</p>
            </div>
        );

        ReactDOM.createRoot(document.getElementById('root')).render(<MainApp />);
    </script>

</body>
</html>