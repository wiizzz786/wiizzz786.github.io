<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcade Host Platform</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load React, ReactDOM, and Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Configure Font for Tailwind -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        /* Custom styles for the game iframe to take up max space */
        .game-iframe {
            width: 100%;
            height: calc(100vh - 12rem); /* Adjusted height to fit within the screen */
            border: 4px solid #4f46e5;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            background-color: white;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Load Lucide Icons UMD Bundle (This defines the global 'lucide' variable) -->
    <script src="https://unpkg.com/lucide-react@latest/umd/lucide-react.js"></script>

    <!-- Firebase Imports and Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, addDoc, serverTimestamp, doc, setDoc, where, getDocs, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase functions globally for the Babel script
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, 
            getFirestore, collection, onSnapshot, query, addDoc, serverTimestamp, doc, setDoc, where, getDocs, getDoc, updateDoc, 
        };
    </script>

    <!-- The React App Logic (Transpiled by Babel) -->
    <script type="text/babel">
        
        // --- 1. DUMMY CONFIGURATION FOR LOCAL TESTING ---
        const DUMMY_FIREBASE_CONFIG = {
            apiKey: "DUMMY_LOCAL_API_KEY", 
            authDomain: "dummy-auth.firebaseapp.com",
            projectId: "dummy-project-12345", 
            appId: "1:123:web:dummy",
            storageBucket: "dummy-bucket.appspot.com" // Added more required fields
        };
        const DUMMY_APP_ID = 'local-dev-arcade-app';
        
        // --- 2. ROBUST CHECK FOR ENVIRONMENT VARIABLES ---
        
        const IS_CANVAS_ENV = typeof __app_id !== 'undefined';
        const appId = IS_CANVAS_ENV ? __app_id : DUMMY_APP_ID;

        let firebaseConfig;
        let isConfigValid = false;

        if (IS_CANVAS_ENV && typeof __firebase_config !== 'undefined' && __firebase_config) {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
                // Simple validation check: ensure essential keys exist
                if (firebaseConfig.apiKey && firebaseConfig.projectId) {
                    isConfigValid = true;
                } else {
                    console.error("Platform config is missing essential keys. Falling back to dummy.");
                }
            } catch (e) {
                console.error("Failed to parse __firebase_config, falling back to dummy config.", e);
            }
        }
        
        if (!isConfigValid) {
            firebaseConfig = DUMMY_FIREBASE_CONFIG;
        }

        const initialAuthToken = IS_CANVAS_ENV && typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Hardcoded admin credentials
        const HARDCODED_ADMIN_USERNAME = "hkh";
        const HARDCODED_ADMIN_PASSWORD = "player9563";

        // Destructure necessary React hooks and Firebase functions from globals
        const { useState, useEffect, useMemo } = React;
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, getFirestore, collection, onSnapshot, query, addDoc, serverTimestamp, doc, setDoc, where, getDocs, getDoc, updateDoc } = window.firebase;
        
        // --- Defensive Icon Loading Utility ---
        const getIcon = (name) => {
            if (window.lucide && window.lucide[name]) {
                return window.lucide[name];
            }
            return ({ className = '' }) => <span className={`text-red-500 ${className}`}>[ICON]</span>;
        };

        const RefreshCw = getIcon('RefreshCw');
        const LogIn = getIcon('LogIn');
        const UserPlus = getIcon('UserPlus');
        const Gamepad = getIcon('Gamepad');
        const Lock = getIcon('Lock');
        const CheckCircle = getIcon('CheckCircle');
        const UploadCloud = getIcon('UploadCloud');
        const Code = getIcon('Code');
        const Settings = getIcon('Settings');
        const ArrowLeft = getIcon('ArrowLeft');
        const AlertTriangle = getIcon('AlertTriangle');
        const Key = getIcon('Key');


        // --- Utility Functions for Base64 Encoding/Decoding (Used for "Hashed" Password Storage) ---
        const encodeBase64 = (str) => btoa(unescape(encodeURIComponent(str)));
        const decodeBase64 = (str) => {
            try {
                return decodeURIComponent(escape(atob(str)));
            } catch (e) {
                return `Error: Decoding failed. Check if the string is valid Base64: ${e.message}`;
            }
        };

        // --- Utility Components ---
        const LoadingIndicator = () => (
            <div className="flex items-center justify-center p-8">
                <RefreshCw className="w-6 h-6 animate-spin text-indigo-500" />
                <span className="ml-3 text-lg font-medium text-gray-700">Initializing...</span>
            </div>
        );

        // Unified Authentication Screen (handles both Login and Register)
        const AuthScreen = ({ setUser, db, auth, setRoute }) => { 
            const [isLogin, setIsLogin] = useState(true);
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState(null);
            const [success, setSuccess] = useState(null);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError(null);
                setSuccess(null);

                if (username.length < 3 || password.length < 6) {
                    setError("Username must be 3+ characters and Password 6+ characters.");
                    return;
                }

                try {
                    // 1. Get the current authenticated user (sign in anonymously if necessary)
                    let currentUser = auth.currentUser;
                    if (!currentUser) {
                        // This should ideally happen only once during initial load (in App component), but here as a fallback
                        await signInAnonymously(auth);
                        currentUser = auth.currentUser;
                    }
                    
                    // Encode the input password for verification/storage
                    const encodedPassword = encodeBase64(password);
                    const usersCollectionRef = collection(db, `/artifacts/${appId}/public/data/users`);
                    
                    // --- HARDCODED ADMIN CHECK (Only on Login Path) ---
                    if (isLogin && username === HARDCODED_ADMIN_USERNAME && encodedPassword === encodeBase64(HARDCODED_ADMIN_PASSWORD)) {
                        
                        const adminUserDocRef = doc(db, `/artifacts/${appId}/public/data/users`, currentUser.uid);
                        await setDoc(adminUserDocRef, {
                            username: HARDCODED_ADMIN_USERNAME,
                            role: 'admin',
                            lastActivity: serverTimestamp(),
                            userId: currentUser.uid,
                            encodedPassword: encodedPassword,
                        }, { merge: true });

                        setSuccess(`Welcome, Admin ${HARDCODED_ADMIN_USERNAME}! Redirecting...`);
                        setTimeout(() => {
                            setUser({ uid: currentUser.uid, username: HARDCODED_ADMIN_USERNAME, role: 'admin', isReady: true, encodedPassword });
                            setRoute('dashboard');
                        }, 500);
                        return;
                    }


                    // --- REGULAR USER CHECK (For both Login and Register) ---
                    const q = query(usersCollectionRef, where("username", "==", username));
                    const snapshot = await getDocs(q);
                    const userExists = !snapshot.empty;
                    
                    if (isLogin) {
                        // --- REGULAR LOGIN PATH ---
                        if (!userExists) {
                            setError("Login failed: Account not found. Please register first.");
                            return;
                        }

                        const userDoc = snapshot.docs[0];
                        const existingUser = userDoc.data();

                        // 2. Verify Password against stored encoded value
                        if (existingUser.encodedPassword !== encodedPassword) {
                            setError("Login failed: Incorrect password.");
                            return;
                        }

                        // If successful, update the user profile document using the CURRENT anonymous UID.
                        const userDocRef = doc(db, `/artifacts/${appId}/public/data/users`, currentUser.uid);
                        await setDoc(userDocRef, {
                            username: existingUser.username,
                            role: existingUser.role || 'player', 
                            lastActivity: serverTimestamp(),
                            userId: currentUser.uid,
                            encodedPassword: existingUser.encodedPassword, 
                        }, { merge: true });

                        setSuccess(`Welcome back, ${existingUser.username}! Redirecting...`);
                        setTimeout(() => {
                            setUser({ uid: currentUser.uid, username: existingUser.username, role: existingUser.role || 'player', isReady: true, encodedPassword: existingUser.encodedPassword });
                            setRoute('dashboard');
                        }, 500);

                    } else {
                        // --- REGISTRATION PATH ---
                        if (userExists) {
                            setError("Registration failed: Username already taken.");
                            return;
                        }

                        // Registration successful: Create a new user profile document using the CURRENT anonymous UID.
                        const userDocRef = doc(db, `/artifacts/${appId}/public/data/users`, currentUser.uid);
                        await setDoc(userDocRef, {
                            username: username,
                            role: 'player', // Default role is 'player'
                            lastActivity: serverTimestamp(),
                            userId: currentUser.uid,
                            encodedPassword: encodedPassword, // Store the encoded password
                        }, { merge: true });

                        setSuccess(`Registration successful for user: ${username}!`);
                        setTimeout(() => {
                            setUser({ uid: currentUser.uid, username, role: 'player', isReady: true, encodedPassword });
                            setRoute('dashboard');
                        }, 500);
                    }

                } catch (err) {
                    console.error("Auth Error:", err);
                    setError(`Authentication failed: ${err.message}. Please try again.`);
                }
            };

            return (
                <div className="w-full max-w-md p-8 bg-white shadow-2xl rounded-xl">
                    <h2 className="text-3xl font-extrabold text-gray-900 mb-6 text-center">
                        <span className="flex items-center justify-center">
                            {isLogin ? <LogIn className="w-7 h-7 mr-3 text-indigo-500" /> : <UserPlus className="w-7 h-7 mr-3 text-indigo-500" />}
                            {isLogin ? 'Sign In' : 'Register Account'}
                        </span>
                    </h2>
                    <div className="text-center text-sm text-gray-600 mb-6 p-3 bg-red-50 rounded-lg border border-red-200">
                        <AlertTriangle className="inline w-4 h-4 mr-2 text-red-600" />
                        **Security Notice:** Passwords are Base64 encoded for storage, but this app runs entirely on the frontend, meaning this is not a secure, production-ready login system.
                    </div>
                    {error && (
                        <div className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 font-medium text-sm border border-red-300">
                            Error: {error}
                        </div>
                    )}
                    {success && (
                        <div className="bg-green-100 text-green-700 p-3 rounded-lg mb-4 font-medium text-sm border border-green-300">
                            <CheckCircle className="inline w-4 h-4 mr-2" />
                            {success}
                        </div>
                    )}
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Username</label>
                            <input
                                type="text"
                                value={username}
                                onChange={(e) => setUsername(e.target.value)}
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out shadow-sm"
                                placeholder="Enter your username"
                                required
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input
                                type="password"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out shadow-sm"
                                placeholder="••••••••"
                                required
                            />
                        </div>
                        <button
                            type="submit"
                            className="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-200 ease-in-out font-semibold shadow-md active:shadow-none"
                        >
                            {isLogin ? 'Log In' : 'Register'}
                        </button>
                    </form>
                    <div className="mt-4 text-center text-sm text-gray-500">
                        <button
                            onClick={() => { setIsLogin(!isLogin); setError(null); setSuccess(null); }}
                            className="text-indigo-600 hover:text-indigo-800 font-medium"
                        >
                            {isLogin ? 'Need an account? Register here.' : 'Already have an account? Log In.'}
                        </button>
                    </div>
                </div>
            );
        };

        const PasswordChangeForm = ({ user, db, userEncodedPassword }) => {
            const [oldPassword, setOldPassword] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [message, setMessage] = useState('');
            const [isExpanded, setIsExpanded] = useState(false);

            const handlePasswordChange = async (e) => {
                e.preventDefault();
                setMessage('');

                if (user.role === 'admin') {
                    setMessage('Error: Admin password changes must be handled by updating the hardcoded credentials directly in the source code.');
                    return;
                }
                
                if (newPassword.length < 6) {
                    setMessage('Error: New password must be at least 6 characters long.');
                    return;
                }
                if (newPassword !== confirmPassword) {
                    setMessage('Error: New password and confirmation do not match.');
                    return;
                }

                const encodedOldPassword = encodeBase64(oldPassword);
                if (encodedOldPassword !== userEncodedPassword) {
                    setMessage('Error: Current password is incorrect.');
                    return;
                }

                try {
                    const userDocRef = doc(db, `/artifacts/${appId}/public/data/users`, user.uid);
                    // Only update the encoded password field
                    await updateDoc(userDocRef, {
                        encodedPassword: encodeBase64(newPassword),
                        lastPasswordChange: serverTimestamp(),
                    });

                    setMessage('Success: Your password has been changed successfully!');
                    setOldPassword('');
                    setNewPassword('');
                    setConfirmPassword('');
                    setIsExpanded(false); // Collapse on success

                } catch (error) {
                    console.error("Password update error:", error);
                    setMessage(`Failed to update password: ${error.message}`);
                }
            };

            return (
                <div className="mt-6">
                    <button
                        onClick={() => setIsExpanded(!isExpanded)}
                        className="w-full flex justify-between items-center px-4 py-3 bg-indigo-100 text-indigo-700 font-bold rounded-lg hover:bg-indigo-200 transition shadow-lg"
                    >
                        <span className="flex items-center">
                            <Lock className="w-5 h-5 mr-3" />
                            {user.role === 'admin' ? 'Admin Credential Info' : 'Change Your Password'}
                        </span>
                        <span>{isExpanded ? '−' : '+'}</span>
                    </button>
                    {isExpanded && (
                        <div className="mt-3 p-4 bg-white border border-indigo-200 rounded-lg shadow-inner">
                            <h3 className="text-lg font-bold text-indigo-700 mb-3 flex items-center">
                                <Key className="w-4 h-4 mr-2" />
                                {user.role === 'admin' ? 'Admin Access Details' : 'Player Security Settings'}
                            </h3>
                            {user.role === 'admin' ? (
                                <div className="text-sm text-gray-700 space-y-2">
                                    <p className="p-2 bg-yellow-50 rounded-md border border-yellow-200">
                                        Admin credentials are hardcoded in `index.html` for platform management. They cannot be changed via the UI.
                                    </p>
                                    <p className="font-semibold">Username: <span className="text-indigo-600">{HARDCODED_ADMIN_USERNAME}</span></p>
                                </div>
                            ) : (
                                <form onSubmit={handlePasswordChange} className="space-y-3">
                                    {message && (
                                        <div className={`p-3 rounded-lg font-medium text-sm border ${message.startsWith('Error') ? 'bg-red-100 text-red-700 border-red-300' : 'bg-green-100 text-green-700 border-green-300'}`}>
                                            {message}
                                        </div>
                                    )}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Current Password</label>
                                        <input type="password" value={oldPassword} onChange={(e) => setOldPassword(e.target.value)} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" required />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">New Password (6+ characters)</label>
                                        <input type="password" value={newPassword} onChange={(e) => setNewPassword(e.target.value)} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" required />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Confirm New Password</label>
                                        <input type="password" value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" required />
                                    </div>
                                    <button type="submit" className="w-full bg-indigo-500 text-white py-2 px-4 rounded-lg hover:bg-indigo-600 font-medium transition duration-200 shadow-md">
                                        Update Password
                                    </button>
                                </form>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        const EncoderDecoder = ({ setRoute }) => {
            const [input, setInput] = useState('');
            const [output, setOutput] = useState('');
            const [mode, setMode] = useState('encode'); // 'encode' or 'decode'

            const handleProcess = () => {
                if (!input) {
                    setOutput('Please enter content to process.');
                    return;
                }

                if (mode === 'encode') {
                    const encoded = encodeBase64(input);
                    setOutput(encoded);
                } else {
                    const decoded = decodeBase64(input);
                    setOutput(decoded);
                }
            };

            const handleCopy = () => {
                if (output) {
                    const tempInput = document.createElement('textarea');
                    tempInput.value = output;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    // Use document.execCommand('copy') as navigator.clipboard might not work in iframe environments
                    document.execCommand('copy'); 
                    // Use custom message box instead of alert()
                    const messageBox = document.createElement('div');
                    messageBox.textContent = "Copied to clipboard!";
                    messageBox.className = "fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-green-500 text-white px-6 py-3 rounded-xl shadow-2xl z-50 text-lg font-bold transition-opacity duration-300";
                    document.body.appendChild(messageBox);
                    setTimeout(() => {
                        messageBox.style.opacity = '0';
                        setTimeout(() => document.body.removeChild(messageBox), 300);
                    }, 1000);
                    
                    document.body.removeChild(tempInput);
                }
            };

            return (
                <div className="w-full max-w-4xl p-8 bg-white shadow-2xl rounded-xl">
                    <h2 className="text-3xl font-extrabold text-gray-900 mb-6 flex items-center">
                        <Code className="w-7 h-7 mr-3 text-purple-600" />
                        Content Encoder & Decoder (Base64)
                    </h2>
                    <div className="flex justify-between items-center mb-6 border-b pb-4 border-gray-200">
                        <button
                            onClick={() => setRoute('dashboard')}
                            className="flex items-center bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-200 font-medium text-sm shadow-md active:shadow-none"
                        >
                            <ArrowLeft className="w-4 h-4 mr-2" /> Back to Dashboard
                        </button>
                        <div className="space-x-2 flex">
                            <button
                                onClick={() => { setMode('encode'); setInput(''); setOutput(''); }}
                                className={`px-4 py-2 rounded-lg font-semibold transition ${mode === 'encode' ? 'bg-purple-600 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                            >
                                <UploadCloud className="w-4 h-4 inline mr-2" /> Encode HTML to String
                            </button>
                            <button
                                onClick={() => { setMode('decode'); setInput(''); setOutput(''); }}
                                className={`px-4 py-2 rounded-lg font-semibold transition ${mode === 'decode' ? 'bg-purple-600 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                            >
                                <RefreshCw className="w-4 h-4 inline mr-2" /> Decode String to HTML
                            </button>
                        </div>
                    </div>

                    <div className="space-y-6">
                        <div>
                            <label className="block text-lg font-semibold text-gray-800 mb-2">{mode === 'encode' ? 'Raw HTML/JS Input (Must be complete HTML)' : 'Base64 String Input'}</label>
                            <textarea
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                rows={8}
                                className="w-full p-4 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 shadow-inner resize-y"
                                placeholder={mode === 'encode' ? "Paste your complete HTML game code here..." : "Paste the Base64 string here..."}
                            />
                        </div>
                        <button
                            onClick={handleProcess}
                            className="w-full bg-purple-600 text-white py-3 px-6 rounded-lg font-bold text-lg hover:bg-purple-700 transition duration-200 shadow-xl active:shadow-none flex items-center justify-center"
                        >
                            {mode === 'encode' ? 'Encode to Base64 String' : 'Decode to HTML'}
                        </button>
                        <div>
                            <label className="block text-lg font-semibold text-gray-800 mb-2">{mode === 'encode' ? 'Base64 Output (Copy this!)' : 'Decoded HTML/JS Output'}</label>
                            <div className="relative">
                                <textarea
                                    value={output}
                                    readOnly
                                    rows={8}
                                    className="w-full p-4 border border-gray-300 rounded-lg bg-gray-50 shadow-inner resize-y"
                                    placeholder="Output will appear here..."
                                />
                                {output && mode === 'encode' && (
                                    <button
                                        onClick={handleCopy}
                                        className="absolute top-2 right-2 bg-indigo-500 text-white p-2 rounded-md hover:bg-indigo-600 transition text-sm font-medium flex items-center shadow-md"
                                    >
                                        <Code className="w-4 h-4 mr-1" /> Copy String
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const AdminPanel = ({ user, db }) => {
            const [title, setTitle] = useState('');
            const [encodedGameString, setEncodedGameString] = useState('');
            const [message, setMessage] = useState('');

            const handleAddGame = async (e) => {
                e.preventDefault();
                setMessage('');

                if (!title || !encodedGameString) {
                    setMessage('Please provide both a title and the Base64-encoded game string.');
                    return;
                }
                if (encodedGameString.length < 10) {
                    setMessage('The input string is too short to be valid Base64 content.');
                    return;
                }

                try {
                    // Games are stored in a PUBLIC collection so all users can see them and play them.
                    const gamesCollectionRef = collection(db, `/artifacts/${appId}/public/data/games`);
                    await addDoc(gamesCollectionRef, {
                        title: title,
                        content: encodedGameString, // Save the encoded string
                        addedBy: user.username,
                        userId: user.uid,
                        createdAt: serverTimestamp(),
                    });

                    setMessage('Game added successfully! It is now available to all players.');
                    setTitle('');
                    setEncodedGameString('');

                } catch (error) {
                    console.error("Error adding document: ", error);
                    setMessage(`Failed to add game: ${error.message}`);
                }
            };

            return (
                <div className="w-full p-6 bg-white shadow-2xl rounded-xl border border-red-300">
                    <h3 className="text-xl font-bold text-red-700 mb-4 flex items-center">
                        <Settings className="w-5 h-5 mr-3" />
                        Admin Panel: Add New Encoded Game
                    </h3>
                    <p className="text-sm text-gray-600 mb-4 p-3 bg-red-50 rounded-lg border border-red-200">
                        You must use the **Content Encoder Utility** to convert your HTML game code into a Base64 string before publishing here.
                    </p>

                    <form onSubmit={handleAddGame} className="space-y-4">
                        {message && (
                            <div className={`p-3 rounded-lg font-medium text-sm border ${message.startsWith('Game added') ? 'bg-green-100 text-green-700 border-green-300' : 'bg-red-100 text-red-700 border-red-300'}`}>
                                {message}
                            </div>
                        )}
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Game Title</label>
                            <input
                                type="text"
                                value={title}
                                onChange={(e) => setTitle(e.target.value)}
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"
                                placeholder="e.g., Encoded Tetris"
                                required
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Base64 Encoded Game String</label>
                            <textarea
                                value={encodedGameString}
                                onChange={(e) => setEncodedGameString(e.target.value)}
                                rows={6}
                                className="w-full p-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-inner resize-y"
                                placeholder="Paste the Base64 encoded string here..."
                                required
                            />
                        </div>
                        <button
                            type="submit"
                            className="w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 font-bold transition duration-200 shadow-md active:shadow-none"
                        >
                            Publish Encoded Game
                        </button>
                    </form>
                </div>
            );
        };


        const Dashboard = ({ user, games, onPlayGame, onLogout, onNavigate, db, userEncodedPassword }) => {
            return (
                <div className="w-full max-w-4xl p-8 bg-white shadow-2xl rounded-xl">
                    <div className="flex justify-between items-start border-b pb-4 mb-4">
                        <div>
                            <h2 className="text-3xl font-extrabold text-gray-900 mb-1">
                                Welcome, <span className="text-indigo-600">{user.username}</span>!
                            </h2>
                            <p className="text-sm text-gray-500">
                                Role: <span className="font-semibold text-gray-700">{user.role.toUpperCase()}</span> | User ID: <span className="font-mono text-xs bg-gray-100 p-1 rounded">{user.uid}</span>
                            </p>
                        </div>
                        <button
                            onClick={onLogout}
                            className="flex items-center bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 font-medium transition duration-200 shadow-md active:shadow-none"
                        >
                            <LogIn className="w-4 h-4 mr-2" style={{ transform: 'scaleX(-1)' }} /> Log Out
                        </button>
                    </div>

                    {/* Password Change Form */}
                    <PasswordChangeForm user={user} db={db} userEncodedPassword={userEncodedPassword} />

                    {/* Admin Tools */}
                    {user.role === 'admin' && (
                        <div className="mt-6 p-4 bg-indigo-50 rounded-lg border border-indigo-200 shadow-inner space-y-3">
                            <h3 className="text-lg font-bold text-indigo-700 flex items-center">
                                <Code className="w-5 h-5 mr-2" /> Admin Tools
                            </h3>
                            <button
                                onClick={() => onNavigate('encoder')}
                                className="flex items-center px-4 py-2 rounded-lg font-semibold text-white bg-purple-600 hover:bg-purple-700 transition shadow-lg"
                            >
                                <UploadCloud className="w-4 h-4 mr-2" /> Content Encoder Utility
                            </button>
                            <AdminPanel user={user} db={db} />
                        </div>
                    )}

                    <h3 className="text-2xl font-bold text-gray-800 mt-8 mb-4 border-b pb-2 flex items-center">
                        <Gamepad className="w-5 h-5 mr-3 text-indigo-600" />
                        Available Games ({games.length})
                    </h3>
                    
                    {games.length === 0 ? (
                        <div className="p-6 text-center text-gray-500 bg-gray-50 rounded-lg border border-gray-200">
                            <AlertTriangle className="w-6 h-6 inline mr-2 text-yellow-500" />
                            No games have been added yet. {user.role === 'admin' && "Please use the Admin Panel above to publish your first game."}
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {games.map(game => (
                                <div key={game.id} className="bg-gray-50 p-5 rounded-xl shadow-lg border border-gray-200 flex flex-col justify-between hover:shadow-xl transition duration-300">
                                    <div>
                                        <h4 className="text-xl font-bold text-indigo-700 mb-1">{game.title}</h4>
                                        <p className="text-xs text-gray-500 mb-3">Added by: {game.addedBy || 'N/A'}</p>
                                    </div>
                                    <button
                                        onClick={() => onPlayGame(game)}
                                        className="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 font-medium transition duration-200 shadow-md active:shadow-none mt-4"
                                    >
                                        <Gamepad className="w-4 h-4 inline mr-2" /> Play Now
                                    </button>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const GamePlayer = ({ game, onBack }) => {
            // 1. Decode the Base64 string back into raw HTML content using useMemo for stability
            const decodedHtml = useMemo(() => {
                return decodeBase64(game.content);
            }, [game.content]);

            // 2. Check for decoding error
            const isError = decodedHtml.startsWith("Error");

            if (isError) {
                return (
                    <div className="w-full max-w-4xl p-8 bg-white shadow-2xl rounded-xl">
                        <h2 className="text-3xl font-extrabold text-red-600 mb-6 flex items-center">
                            <AlertTriangle className="w-7 h-7 mr-3" /> Content Error
                        </h2>
                        <div className="bg-red-100 text-red-700 p-4 rounded-lg font-mono text-sm overflow-auto max-h-60 border border-red-300 mb-4">
                            {decodedHtml}
                        </div>
                        <button
                            onClick={onBack}
                            className="flex items-center bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 font-medium transition duration-200 shadow-md active:shadow-none"
                        >
                            <ArrowLeft className="w-4 h-4 mr-2" /> Back to Dashboard
                        </button>
                    </div>
                );
            }

            // 3. Render the game using an iframe's srcDoc attribute
            return (
                <div className="w-full p-6 bg-white shadow-2xl rounded-xl">
                    <div className="flex justify-between items-center mb-4 pb-4 border-b border-gray-200">
                        <h2 className="text-3xl font-extrabold text-indigo-600 flex items-center">
                            <Gamepad className="w-7 h-7 mr-3" /> Playing: {game.title}
                        </h2>
                        <button
                            onClick={onBack}
                            className="flex items-center bg-indigo-500 text-white py-2 px-4 rounded-lg hover:bg-indigo-600 font-medium transition duration-200 shadow-md active:shadow-none"
                        >
                            <ArrowLeft className="w-4 h-4 mr-2" /> Back to Dashboard
                        </button>
                    </div>

                    <iframe 
                        srcDoc={decodedHtml} 
                        className="game-iframe" 
                        title={game.title} 
                        sandbox="allow-scripts allow-same-origin"
                    />

                    <p className="text-xs text-gray-500 mt-4 p-2 bg-gray-50 rounded">
                        The content was successfully decoded and loaded via `srcDoc`. If the game doesn't run, ensure the original HTML was complete and valid.
                    </p>
                </div>
            );
        };
        
        // --- Component for Critical Initialization Failure ---
        const CriticalInitError = () => (
             <div className="w-full max-w-lg p-8 bg-white shadow-2xl rounded-xl text-center">
                <h2 className="text-3xl font-extrabold text-red-600 mb-4 flex items-center justify-center">
                    <AlertTriangle className="w-7 h-7 mr-3" /> Critical Setup Error
                </h2>
                <p className="text-gray-700 mb-4">
                    The application failed to initialize **Firebase services** (`initializeApp`). 
                    This is often caused by invalid or missing configuration from the hosting environment.
                </p>
                <div className="text-left p-4 bg-red-50 rounded-lg border border-red-200 mb-6 text-sm text-gray-600">
                    <p className="font-semibold text-red-700">Debugging Checklist:</p>
                    <ul className="list-disc list-inside mt-1 space-y-1">
                        <li>Check the console for specific `initializeApp` error details.</li>
                        <li>Ensure the host platform is providing valid configuration data.</li>
                        <li>If running locally, verify the dummy configuration has all required fields.</li>
                    </ul>
                </div>
                <button onClick={() => window.location.reload()} className="mt-4 bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 flex items-center mx-auto">
                    <RefreshCw className="w-4 h-4 mr-2" /> Try Reloading
                </button>
            </div>
        );


        // --- Main Application Component ---
        const App = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [user, setUser] = useState(null); // { uid, username, role, isReady, encodedPassword }
            const [games, setGames] = useState([]);
            const [route, setRoute] = useState('loading'); // 'loading', 'login', 'dashboard', 'encoder', 'playGame'
            const [activeGame, setActiveGame] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [isInitFailed, setIsInitFailed] = useState(false); // New state for critical failure

            // 1. Initialize Firebase and Setup Auth Listener
            useEffect(() => {
                let authService, firestore;
                let unsubscribeAuth = () => {};

                try {
                    // Try to initialize core services
                    const app = initializeApp(firebaseConfig);
                    firestore = getFirestore(app);
                    authService = getAuth(app);
                    setDb(firestore);
                    setAuth(authService);
                    
                    // --- Start Auth Flow only if initialization succeeded ---
                    unsubscribeAuth = onAuthStateChanged(authService, async (currentUser) => {
                        if (currentUser) {
                            const userDocRef = doc(firestore, `/artifacts/${appId}/public/data/users`, currentUser.uid);
                            const docSnap = await getDoc(userDocRef);

                            if (docSnap.exists()) {
                                const userData = docSnap.data();
                                setUser({ 
                                    ...userData, 
                                    uid: currentUser.uid, 
                                    isReady: true, 
                                    role: userData.role || 'player', 
                                    encodedPassword: userData.encodedPassword 
                                });
                                setRoute('dashboard');
                            } else {
                                setUser({ uid: currentUser.uid, isReady: true, role: 'unknown', encodedPassword: null });
                                setRoute('login');
                            }
                        } else {
                            // No authenticated user, sign in anonymously to prepare for registration/login
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(authService, initialAuthToken);
                                } else {
                                    await signInAnonymously(authService);
                                }
                            } catch (e) {
                                console.error("Firebase initial sign-in error:", e);
                                setUser({ isReady: true, role: 'unknown', encodedPassword: null });
                                setRoute('login');
                            }
                        }
                        setIsAuthReady(true);
                    });
                } catch (e) {
                    console.error("CRITICAL: Failed to initialize Firebase services. Configuration might be invalid.", e);
                    setIsInitFailed(true); // Flag the critical failure
                    setRoute('loading'); // Stay on loading temporarily until rendering handles the flag
                }
                
                return () => {
                    if (typeof unsubscribeAuth === 'function') {
                        unsubscribeAuth();
                    }
                };
            }, []);

            // 2. Load Games from Public Firestore Collection 
            useEffect(() => {
                // Only listen for games if DB is ready and we are authenticated enough to know the UID
                if (db && auth && user?.uid && user?.isReady) { 
                    const gamesCollectionRef = collection(db, `/artifacts/${appId}/public/data/games`);
                    const q = query(gamesCollectionRef);

                    const unsubscribeGames = onSnapshot(q, (snapshot) => {
                        const fetchedGames = snapshot.docs.map(doc => ({ 
                            id: doc.id, 
                            ...doc.data() 
                        }));
                        setGames(fetchedGames);
                    }, (error) => {
                        console.error("Error fetching games:", error);
                    });

                    return () => unsubscribeGames();
                }
            }, [db, auth, user?.uid, user?.isReady]);

            // Handlers
            const handlePlayGame = (game) => {
                setActiveGame(game);
                setRoute('playGame');
            };

            const handleBackToDashboard = () => {
                setActiveGame(null);
                setRoute('dashboard');
            };

            const handleLogout = async () => {
                if (auth) {
                    await signOut(auth);
                }
                // Force reload to get a new anonymous user/reset state
                window.location.reload();
            };

            const renderContent = () => {
                // Check 1: Critical Initialization Failure
                if (isInitFailed) {
                    return <CriticalInitError />;
                }
                
                // Check 2: Waiting for Auth/DB readiness
                if (route === 'loading' || !db || !auth || !isAuthReady) {
                    return <LoadingIndicator />;
                }

                switch (route) {
                    case 'login':
                        return <AuthScreen setUser={setUser} db={db} auth={auth} setRoute={setRoute} />;
                    case 'dashboard':
                        // Ensure user state is complete before dashboard access
                        if (user?.isReady) {
                            return <Dashboard user={user} games={games} onPlayGame={handlePlayGame} onLogout={handleLogout} onNavigate={setRoute} db={db} userEncodedPassword={user.encodedPassword} />;
                        }
                        return <LoadingIndicator />;
                    case 'encoder':
                        return <EncoderDecoder setRoute={setRoute} />;
                    case 'playGame':
                        return <GamePlayer game={activeGame} onBack={handleBackToDashboard} />;
                    default:
                        return <LoadingIndicator />;
                }
            };

            return (
                <div className="min-h-screen flex flex-col items-center py-10 px-4 bg-gray-100">
                    <header className="mb-8 text-center">
                        <h1 className="text-5xl font-extrabold text-gray-900 flex items-center justify-center">
                            <Gamepad className="w-10 h-10 mr-4 text-indigo-600" /> Arcade Host
                        </h1>
                        <p className="text-lg text-gray-600 mt-2">The collaborative platform for shared Base64-encoded games.</p>
                    </header>
                    {renderContent()}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
