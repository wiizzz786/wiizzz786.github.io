import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from 'firebase/auth';
import { getFirestore, collection, onSnapshot, query, addDoc, serverTimestamp, doc, setDoc, where, getDocs, getDoc, updateDoc } from 'firebase/firestore'; 
import { RefreshCw, LogIn, UserPlus, Gamepad, Lock, CheckCircle, UploadCloud, Code, Settings, ArrowLeft, AlertTriangle, Key } from 'lucide-react';

// --- GLOBAL FIREBASE VARIABLES ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// --- HARDCODED ADMIN CREDENTIALS ---
const HARDCODED_ADMIN_USERNAME = "hkh";
const HARDCODED_ADMIN_PASSWORD = "player9563";

// --- Utility Functions for Base64 Encoding/Decoding (Used for "Hashed" Password Storage) ---
// WARNING: This is NOT a secure hashing mechanism, but fulfills the requirement for password
// storage/verification in this frontend-only environment without storing passwords in plain text.
const encodeBase64 = (str) => btoa(unescape(encodeURIComponent(str)));
const decodeBase64 = (str) => {
    try {
        return decodeURIComponent(escape(atob(str)));
    } catch (e) {
        return `Error: Decoding failed. Check if the string is valid Base64: ${e.message}`;
    }
};

// --- Utility Components ---

const LoadingIndicator = () => (
    <div className="flex items-center justify-center p-8">
        <RefreshCw className="w-6 h-6 animate-spin text-indigo-500" />
        <span className="ml-3 text-lg font-medium text-gray-700">Initializing...</span>
    </div>
);

// Unified Authentication Screen (handles both Login and Register)
const AuthScreen = ({ setUser, db, auth }) => {
    const [isLogin, setIsLogin] = useState(true);
    const [username, setUsername] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState(null);
    const [success, setSuccess] = useState(null);

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError(null);
        setSuccess(null);

        if (username.length < 3 || password.length < 6) {
            setError("Username must be 3+ characters and Password 6+ characters.");
            return;
        }

        try {
            // 1. Get the current authenticated user (sign in anonymously if necessary)
            let currentUser = auth.currentUser;
            if (!currentUser) {
                await signInAnonymously(auth);
                currentUser = auth.currentUser;
            }
            
            // Encode the input password for verification/storage
            const encodedPassword = encodeBase64(password);
            const usersCollectionRef = collection(db, `/artifacts/${appId}/public/data/users`);
            
            // --- HARDCODED ADMIN CHECK (Only on Login Path) ---
            if (isLogin && username === HARDCODED_ADMIN_USERNAME && encodedPassword === encodeBase64(HARDCODED_ADMIN_PASSWORD)) {
                
                // Admin login successful: Create/update their profile using the current UID
                const adminUserDocRef = doc(db, `/artifacts/${appId}/public/data/users`, currentUser.uid);
                await setDoc(adminUserDocRef, {
                    username: HARDCODED_ADMIN_USERNAME,
                    role: 'admin',
                    lastActivity: serverTimestamp(),
                    userId: currentUser.uid,
                    encodedPassword: encodedPassword, // Store the encoded password
                }, { merge: true });

                setSuccess(`Welcome, Admin ${HARDCODED_ADMIN_USERNAME}! Redirecting...`);
                // Pass encodedPassword to user state
                setTimeout(() => setUser({ uid: currentUser.uid, username: HARDCODED_ADMIN_USERNAME, role: 'admin', isReady: true, encodedPassword }), 500);
                return; // Stop the regular Firestore check
            }


            // --- REGULAR USER CHECK (For both Login and Register) ---
            const q = query(usersCollectionRef, where("username", "==", username));
            const snapshot = await getDocs(q);
            const userExists = !snapshot.empty;
            
            if (isLogin) {
                // --- REGULAR LOGIN PATH ---
                if (!userExists) {
                    setError("Login failed: Account not found. Please register first.");
                    return;
                }

                const userDoc = snapshot.docs[0];
                const existingUser = userDoc.data();

                // 2. Verify Password against stored encoded value
                if (existingUser.encodedPassword !== encodedPassword) {
                    setError("Login failed: Incorrect password.");
                    return;
                }

                // If successful, update the user profile document using the CURRENT anonymous UID.
                const userDocRef = doc(db, `/artifacts/${appId}/public/data/users`, currentUser.uid);
                await setDoc(userDocRef, {
                    username: existingUser.username,
                    role: existingUser.role || 'player', 
                    lastActivity: serverTimestamp(),
                    userId: currentUser.uid,
                    encodedPassword: existingUser.encodedPassword, 
                }, { merge: true });

                setSuccess(`Welcome back, ${existingUser.username}! Redirecting...`);
                // Pass encodedPassword to user state
                setTimeout(() => setUser({ uid: currentUser.uid, username: existingUser.username, role: existingUser.role || 'player', isReady: true, encodedPassword: existingUser.encodedPassword }), 500);

            } else {
                // --- REGISTRATION PATH ---
                if (userExists) {
                    setError("Registration failed: Username already taken.");
                    return;
                }

                // Registration successful: Create a new user profile document using the CURRENT anonymous UID.
                const userDocRef = doc(db, `/artifacts/${appId}/public/data/users`, currentUser.uid);
                await setDoc(userDocRef, {
                    username: username,
                    role: 'player', // Default role is 'player'
                    lastActivity: serverTimestamp(),
                    userId: currentUser.uid,
                    encodedPassword: encodedPassword, // Store the encoded password
                }, { merge: true });

                setSuccess(`Registration successful for user: ${username}!`);
                // Pass encodedPassword to user state
                setTimeout(() => setUser({ uid: currentUser.uid, username, role: 'player', isReady: true, encodedPassword }), 500);
            }

        } catch (err) {
            console.error("Auth Error:", err);
            setError(`Authentication failed: ${err.message}. Please try again.`);
        }
    };

    return (
        <div className="w-full max-w-md p-8 bg-white shadow-2xl rounded-xl">
            <h2 className="text-3xl font-extrabold text-gray-900 mb-6 text-center">
                <span className="flex items-center justify-center">
                    {isLogin ? <LogIn className="w-7 h-7 mr-3 text-indigo-500" /> : <UserPlus className="w-7 h-7 mr-3 text-indigo-500" />}
                    {isLogin ? 'Sign In' : 'Register Account'}
                </span>
            </h2>
            <div className="text-center text-sm text-gray-600 mb-6 p-3 bg-red-50 rounded-lg border border-red-200">
                <AlertTriangle className="inline w-4 h-4 mr-2 text-red-600" />
                **Security Notice:** Passwords are Base64 encoded for storage, but this app runs entirely on the frontend, meaning this is not a secure, production-ready login system.
            </div>
            {error && (
                <div className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 font-medium text-sm border border-red-300">
                    Error: {error}
                </div>
            )}
            {success && (
                <div className="bg-green-100 text-green-700 p-3 rounded-lg mb-4 font-medium text-sm border border-green-300">
                    <CheckCircle className="inline w-4 h-4 mr-2" />
                    {success}
                </div>
            )}
            <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input
                        type="text"
                        value={username}
                        onChange={(e) => setUsername(e.target.value)}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out shadow-sm"
                        placeholder="Enter your username"
                        required
                    />
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input
                        type="password"
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out shadow-sm"
                        placeholder="••••••••"
                        required
                    />
                </div>
                <button
                    type="submit"
                    className="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-200 ease-in-out font-semibold shadow-md active:shadow-none"
                >
                    {isLogin ? 'Log In' : 'Register'}
                </button>
            </form>
            <div className="mt-4 text-center text-sm text-gray-500">
                <button
                    onClick={() => { setIsLogin(!isLogin); setError(null); setSuccess(null); }}
                    className="text-indigo-600 hover:text-indigo-800 font-medium"
                >
                    {isLogin ? 'Need an account? Register here.' : 'Already have an account? Log In.'}
                </button>
            </div>
        </div>
    );
};

const PasswordChangeForm = ({ user, db, userEncodedPassword }) => {
    const [oldPassword, setOldPassword] = useState('');
    const [newPassword, setNewPassword] = useState('');
    const [confirmPassword, setConfirmPassword] = useState('');
    const [message, setMessage] = useState('');
    const [isExpanded, setIsExpanded] = useState(false);

    const handlePasswordChange = async (e) => {
        e.preventDefault();
        setMessage('');

        if (user.role === 'admin') {
            setMessage('Error: Admin password changes must be handled by updating the hardcoded credentials directly in the source code.');
            return;
        }

        if (newPassword.length < 6) {
            setMessage('Error: New password must be at least 6 characters long.');
            return;
        }

        if (newPassword !== confirmPassword) {
            setMessage('Error: New password and confirmation do not match.');
            return;
        }

        const encodedOldPassword = encodeBase64(oldPassword);
        if (encodedOldPassword !== userEncodedPassword) {
            setMessage('Error: Current password is incorrect.');
            return;
        }

        try {
            const userDocRef = doc(db, `/artifacts/${appId}/public/data/users`, user.uid);
            
            // Only update the encoded password field
            await updateDoc(userDocRef, {
                encodedPassword: encodeBase64(newPassword),
                lastPasswordChange: serverTimestamp(),
            });

            setMessage('Success: Your password has been changed successfully!');
            setOldPassword('');
            setNewPassword('');
            setConfirmPassword('');
            setIsExpanded(false); // Collapse on success

        } catch (error) {
            console.error("Password update error:", error);
            setMessage(`Failed to update password: ${error.message}`);
        }
    };

    return (
        <div className="mt-8">
            <button
                onClick={() => setIsExpanded(!isExpanded)}
                className="w-full flex justify-between items-center px-4 py-3 bg-indigo-100 text-indigo-700 font-bold rounded-lg hover:bg-indigo-200 transition shadow-lg"
            >
                <span className="flex items-center">
                    <Key className="w-5 h-5 mr-3" />
                    {user.role === 'admin' ? 'Admin Credential Info' : 'Change Your Password'}
                </span>
                <span className="text-xl">{isExpanded ? '−' : '+'}</span>
            </button>

            {isExpanded && (
                <div className="p-6 bg-white border border-indigo-200 rounded-b-lg shadow-inner mt-0">
                    <h4 className="text-xl font-semibold mb-4 text-indigo-800">
                        {user.role === 'admin' ? 'Admin Access Details' : 'Player Security Settings'}
                    </h4>
                    
                    {user.role === 'admin' ? (
                        <p className="text-sm text-gray-600 p-3 bg-yellow-50 rounded-lg">
                           Admin credentials are hardcoded in `App.jsx` for platform management. They cannot be changed via the UI.
                           <br />Username: <span className="font-mono font-bold text-gray-800">{HARDCODED_ADMIN_USERNAME}</span>
                        </p>
                    ) : (
                        <>
                            {message && (
                                <div className={`p-3 rounded-lg mb-4 font-medium text-sm ${message.includes('Success') ? 'bg-green-100 text-green-700 border border-green-300' : 'bg-red-100 text-red-700 border border-red-300'}`}>
                                    {message}
                                </div>
                            )}
                            <form onSubmit={handlePasswordChange} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Current Password</label>
                                    <input
                                        type="password"
                                        value={oldPassword}
                                        onChange={(e) => setOldPassword(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">New Password (6+ characters)</label>
                                    <input
                                        type="password"
                                        value={newPassword}
                                        onChange={(e) => setNewPassword(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Confirm New Password</label>
                                    <input
                                        type="password"
                                        value={confirmPassword}
                                        onChange={(e) => setConfirmPassword(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"
                                        required
                                    />
                                </div>
                                <button
                                    type="submit"
                                    className="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 font-semibold shadow-md active:shadow-none"
                                >
                                    Update Password
                                </button>
                            </form>
                        </>
                    )}
                </div>
            )}
        </div>
    );
}

const EncoderDecoder = ({ setRoute }) => {
    const [input, setInput] = useState('');
    const [output, setOutput] = useState('');
    const [mode, setMode] = useState('encode'); // 'encode' or 'decode'

    const handleProcess = () => {
        if (!input) {
            setOutput('Please enter content to process.');
            return;
        }

        if (mode === 'encode') {
            const encoded = encodeBase64(input);
            setOutput(encoded);
        } else {
            const decoded = decodeBase64(input);
            setOutput(decoded);
        }
    };

    const handleCopy = () => {
        if (output) {
            const tempInput = document.createElement('textarea');
            tempInput.value = output;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
        }
    };

    return (
        <div className="p-6 bg-white rounded-lg shadow-2xl w-full max-w-4xl">
            <div className="flex justify-between items-center mb-6 border-b pb-4">
                <h2 className="text-3xl font-bold text-gray-800 flex items-center">
                    <Code className="w-6 h-6 mr-3 text-purple-600" />
                    Content Encoder & Decoder (Base64)
                </h2>
                <button
                    onClick={() => setRoute('dashboard')}
                    className="flex items-center bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-200 font-medium text-sm shadow-md active:shadow-none"
                >
                    <ArrowLeft className="w-4 h-4 mr-2" /> Back to Dashboard
                </button>
            </div>

            <div className="flex space-x-2 mb-4">
                <button
                    onClick={() => { setMode('encode'); setInput(''); setOutput(''); }}
                    className={`px-4 py-2 rounded-lg font-semibold transition ${mode === 'encode' ? 'bg-purple-600 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                >
                    Encode HTML to String
                </button>
                <button
                    onClick={() => { setMode('decode'); setInput(''); setOutput(''); }}
                    className={`px-4 py-2 rounded-lg font-semibold transition ${mode === 'decode' ? 'bg-purple-600 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                >
                    Decode String to HTML
                </button>
            </div>

            <div className="space-y-4">
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                        {mode === 'encode' ? 'Raw HTML/JS Input (Must be complete HTML)' : 'Base64 String Input'}
                    </label>
                    <textarea
                        value={input}
                        onChange={(e) => setInput(e.target.value)}
                        rows="10"
                        className="w-full px-4 py-3 font-mono text-xs border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 shadow-inner resize-y"
                        placeholder={mode === 'encode' ? '<!DOCTYPE html><html>...</html>' : 'Paste your random letter string here...'}
                    ></textarea>
                </div>

                <button
                    onClick={handleProcess}
                    className="w-full bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 transition duration-200 ease-in-out font-bold text-lg shadow-lg flex items-center justify-center active:shadow-none"
                >
                    {mode === 'encode' ? 'Encode to Base64 String' : 'Decode to HTML'}
                </button>

                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                        {mode === 'encode' ? 'Base64 Output (Copy this!)' : 'Decoded HTML/JS Output'}
                    </label>
                    <div className="relative">
                        <textarea
                            readOnly
                            value={output}
                            rows="10"
                            className="w-full px-4 py-3 font-mono text-xs border border-gray-300 bg-gray-50 rounded-lg shadow-inner resize-y"
                            placeholder="Processed result will appear here..."
                        ></textarea>
                        {output && mode === 'encode' && (
                            <button
                                onClick={handleCopy}
                                className="absolute right-2 top-2 bg-indigo-500 text-white text-xs px-2 py-1 rounded hover:bg-indigo-600 transition"
                            >
                                Copy String
                            </button>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};

const AdminPanel = ({ user, db }) => {
    const [title, setTitle] = useState('');
    const [encodedGameString, setEncodedGameString] = useState('');
    const [message, setMessage] = useState('');

    const handleAddGame = async (e) => {
        e.preventDefault();
        setMessage('');

        if (!title || !encodedGameString) {
            setMessage('Please provide both a title and the Base64-encoded game string.');
            return;
        }

        if (encodedGameString.length < 10) {
             setMessage('The input string is too short to be valid Base64 content.');
             return;
        }

        try {
            // Games are stored in a PUBLIC collection so all users can see them and play them.
            const gamesCollectionRef = collection(db, `/artifacts/${appId}/public/data/games`);
            await addDoc(gamesCollectionRef, {
                title: title,
                content: encodedGameString, // Save the encoded string
                addedBy: user.username,
                userId: user.uid,
                createdAt: serverTimestamp(),
            });

            setMessage('Game added successfully! It is now available to all players.');
            setTitle('');
            setEncodedGameString('');

        } catch (error) {
            console.error("Error adding document: ", error);
            setMessage(`Failed to add game: ${error.message}`);
        }
    };

    return (
        <div className="p-6 bg-white rounded-lg shadow-2xl">
            <h2 className="text-3xl font-bold text-indigo-700 mb-6 flex items-center">
                <Lock className="w-6 h-6 mr-3" />
                Admin Panel: Add New Encoded Game
            </h2>
            <p className="text-sm text-gray-600 mb-4">
                You must use the **Content Encoder Utility** to convert your HTML game code into a Base64 string before publishing here.
            </p>

            {message && (
                <div className={`p-3 rounded-lg mb-4 font-medium text-sm ${message.includes('successfully') ? 'bg-green-100 text-green-700 border border-green-300' : 'bg-red-100 text-red-700 border border-red-300'}`}>
                    {message}
                </div>
            )}

            <form onSubmit={handleAddGame} className="space-y-4">
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Game Title</label>
                    <input
                        type="text"
                        value={title}
                        onChange={(e) => setTitle(e.target.value)}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"
                        placeholder="e.g., Encoded Tetris"
                        required
                    />
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Base64 Encoded Game String</label>
                    <textarea
                        value={encodedGameString}
                        onChange={(e) => setEncodedGameString(e.target.value)}
                        rows="8"
                        className="w-full px-4 py-3 font-mono text-xs border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-inner resize-y"
                        placeholder="Paste your generated Base64 string here..."
                        required
                    ></textarea>
                </div>
                <button
                    type="submit"
                    className="w-full bg-green-500 text-white py-3 px-4 rounded-lg hover:bg-green-600 transition duration-200 ease-in-out font-bold text-lg shadow-lg flex items-center justify-center active:shadow-none"
                >
                    <UploadCloud className="w-5 h-5 mr-2" />
                    Publish Encoded Game
                </button>
            </form>
        </div>
    );
};

const Dashboard = ({ user, games, onPlayGame, onLogout, onNavigate, db, userEncodedPassword }) => {
    return (
        <div className="p-6 bg-gray-50 rounded-lg shadow-2xl w-full">
            <div className="flex justify-between items-start mb-6 border-b pb-4">
                <div>
                    <h2 className="text-4xl font-extrabold text-gray-900">
                        Welcome, <span className="text-indigo-600">{user.username}</span>!
                    </h2>
                    <p className="text-sm text-gray-500 mt-1">
                        Role: <span className={`font-semibold ${user.role === 'admin' ? 'text-red-500' : 'text-green-500'}`}>{user.role.toUpperCase()}</span> | User ID: {user.uid}
                    </p>
                </div>
                <button
                    onClick={onLogout}
                    className="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-200 font-medium text-sm shadow-md active:shadow-none"
                >
                    Log Out
                </button>
            </div>
            
            {/* NEW: Password Change Form */}
            <PasswordChangeForm user={user} db={db} userEncodedPassword={userEncodedPassword} />

            {user.role === 'admin' && (
                <div className="mt-6 mb-6 flex space-x-4 border-t pt-6">
                    <button
                        onClick={() => onNavigate('encoder')}
                        className="flex items-center px-4 py-2 rounded-lg font-semibold text-white bg-purple-600 hover:bg-purple-700 transition shadow-lg"
                    >
                        <Code className="w-4 h-4 mr-2" /> Content Encoder Utility
                    </button>
                </div>
            )}


            <div className="mb-10 mt-6 border-t pt-6">
                <h3 className="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <Gamepad className="w-5 h-5 mr-2 text-indigo-500" />
                    Available Games ({games.length})
                </h3>
                {games.length === 0 ? (
                    <div className="p-6 text-center bg-white rounded-xl shadow-md border border-gray-200">
                        <p className="text-gray-500 italic">No games have been added yet.</p>
                    </div>
                ) : (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {games.map(game => (
                            <div key={game.id} className="bg-white p-5 rounded-xl shadow-lg border border-indigo-100 hover:shadow-xl transition duration-300">
                                <h4 className="text-xl font-semibold text-gray-800 mb-2">{game.title}</h4>
                                <p className="text-xs text-gray-500 mb-3">Added by: {game.addedBy || 'N/A'}</p>
                                <button
                                    onClick={() => onPlayGame(game)}
                                    className="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 font-medium transition duration-200 shadow-md active:shadow-none"
                                >
                                    Play Now
                                </button>
                            </div>
                        ))}
                    </div>
                )}
            </div>

            {user.role === 'admin' && <AdminPanel user={user} db={db} />}
        </div>
    );
};

const GamePlayer = ({ game, onBack }) => {
    
    // 1. Decode the Base64 string back into raw HTML content using useMemo for stability
    const decodedHtml = useMemo(() => {
        return decodeBase64(game.content);
    }, [game.content]); 
    
    // 2. Check for decoding error
    const isError = decodedHtml.startsWith("Error");
    
    if (isError) {
        return (
            <div className="p-8 bg-red-100 rounded-lg shadow-2xl w-full max-w-xl text-center">
                <h2 className="text-2xl font-bold text-red-700 mb-4">Content Error</h2>
                <p className="text-red-600 mb-6">{decodedHtml}</p>
                <button
                    onClick={onBack}
                    className="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 font-medium transition duration-200 shadow-md active:shadow-none"
                >
                    Back to Dashboard
                </button>
            </div>
        );
    }

    return (
        <div className="p-4 bg-gray-900 rounded-lg shadow-2xl h-[90vh] flex flex-col w-full max-w-6xl">
            <div className="flex justify-between items-center mb-4 pb-2 border-b border-gray-700">
                <h2 className="text-2xl font-bold text-white">Playing: {game.title}</h2>
                <button
                    onClick={onBack}
                    className="bg-indigo-500 text-white py-2 px-4 rounded-lg hover:bg-indigo-600 transition duration-200 font-medium shadow-md active:shadow-none"
                >
                    Back to Dashboard
                </button>
            </div>
            <div className="flex-grow bg-white rounded-lg overflow-hidden">
                <iframe
                    srcDoc={decodedHtml}
                    title={game.title}
                    // IMPORTANT: Sandbox attributes are crucial for security when loading dynamic content.
                    sandbox="allow-scripts allow-forms allow-same-origin"
                    className="w-full h-full border-none"
                ></iframe>
            </div>
            <p className="text-xs text-gray-400 mt-2">The content was successfully decoded and loaded via `srcDoc`. If the game doesn't run, ensure the original HTML was complete and valid.</p>
        </div>
    );
};

// --- Main Application Component ---
const App = () => {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    // User state now includes encodedPassword
    const [user, setUser] = useState(null); // { uid, username, role, isReady, encodedPassword } 
    const [games, setGames] = useState([]);
    const [route, setRoute] = useState('login'); // 'login', 'dashboard', 'encoder', 'playGame'
    const [activeGame, setActiveGame] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false); 

    // 1. Initialize Firebase and Setup Auth Listener
    useEffect(() => {
        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase config is missing.");
            return;
        }

        const app = initializeApp(firebaseConfig);
        const firestore = getFirestore(app);
        const authService = getAuth(app);
        setDb(firestore);
        setAuth(authService);
        
        // --- Start Auth Flow ---
        const unsubscribeAuth = onAuthStateChanged(authService, async (currentUser) => {
            if (currentUser) {
                // If the user is authenticated (even anonymously), check if they have a registered user profile document
                const userDocRef = doc(firestore, `/artifacts/${appId}/public/data/users`, currentUser.uid);
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    // IMPORTANT: Include encodedPassword in user state for password change checks
                    setUser({ ...userData, uid: currentUser.uid, isReady: true, role: userData.role || 'player', encodedPassword: userData.encodedPassword });
                    setRoute('dashboard');
                } else {
                    // User is authenticated but no profile exists. Must log in/register.
                    setUser({ uid: currentUser.uid, isReady: true, role: 'unknown' });
                    setRoute('login');
                }
            } else {
                // No authenticated user, sign in anonymously to prepare for registration/login
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(authService, initialAuthToken);
                    } else {
                        await signInAnonymously(authService);
                    }
                } catch (e) {
                    console.error("Firebase initial sign-in error:", e);
                    setUser({ isReady: true });
                    setRoute('login');
                }
            }
            setIsAuthReady(true);
        });

        return () => {
            if (typeof unsubscribeAuth === 'function') {
                unsubscribeAuth();
            }
        };
    }, []);

    // 2. Load Games from Public Firestore Collection (Dependent on DB readiness and User Auth)
    useEffect(() => {
        if (db && user?.uid && user?.isReady) {
            // All users (admins and players) listen to the same public path for games.
            const gamesCollectionRef = collection(db, `/artifacts/${appId}/public/data/games`);
            const q = query(gamesCollectionRef);

            const unsubscribeGames = onSnapshot(q, (snapshot) => {
                const fetchedGames = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                setGames(fetchedGames);
            }, (error) => {
                console.error("Error fetching games:", error);
            });

            return () => unsubscribeGames();
        }
    }, [db, user?.uid, user?.isReady]);

    // Handlers
    const handleLoginSuccess = (userData) => {
        setUser(userData);
        setRoute('dashboard');
    };

    const handlePlayGame = (game) => {
        setActiveGame(game);
        setRoute('playGame');
    };

    const handleBackToDashboard = () => {
        setActiveGame(null);
        setRoute('dashboard');
    };

    const handleLogout = async () => {
        if (auth) {
            await signOut(auth);
        }
        // Force reload to get a new anonymous user/reset state
        window.location.reload(); 
    };

    const renderContent = () => {
        // Wait for user auth status to be resolved
        if (!isAuthReady || !db || !auth) {
            return <LoadingIndicator />;
        }

        switch (route) {
            case 'login':
                return <AuthScreen setUser={handleLoginSuccess} db={db} auth={auth} />;
            case 'dashboard':
                // Check if user object is fully populated before rendering dashboard
                if (user?.isReady) {
                    return <Dashboard 
                                user={user} 
                                games={games} 
                                onPlayGame={handlePlayGame} 
                                onLogout={handleLogout} 
                                onNavigate={setRoute} 
                                db={db} 
                                userEncodedPassword={user.encodedPassword} // Pass for validation
                            />;
                }
                return <LoadingIndicator />;
            case 'encoder':
                return <EncoderDecoder setRoute={setRoute} />;
            case 'playGame':
                return <GamePlayer game={activeGame} onBack={handleBackToDashboard} />;
            default:
                return <AuthScreen setUser={handleLoginSuccess} db={db} auth={auth} />;
        }
    };

    return (
        <div className="min-h-screen bg-gray-100 p-4 sm:p-8 flex flex-col items-center justify-center font-sans">
            <header className="mb-8 w-full max-w-6xl text-center">
                <h1 className="text-5xl font-extrabold text-indigo-800 tracking-tight">
                    <span className="bg-clip-text text-transparent bg-gradient-to-r from-indigo-500 to-purple-600">
                        Arcade Host
                    </span>
                </h1>
                <p className="text-lg text-gray-500 mt-2">The collaborative platform for shared Base64-encoded games.</p>
            </header>
            <main className="w-full max-w-6xl flex-grow flex justify-center items-start">
                {renderContent()}
            </main>
        </div>
    );
};

export default App;
